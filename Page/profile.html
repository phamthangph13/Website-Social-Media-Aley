<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aley - Hồ sơ</title>
    <link rel="stylesheet" href="Styles/global.css">
    <link rel="stylesheet" href="Styles/profile.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        /* Hashtag styles */
        .hashtag {
            font-weight: 600;
            border-radius: 4px;
            padding: 0 2px;
            margin: 0 -2px;
            display: inline-block;
            position: relative;
            animation: hashtag-pulse 2s ease-in-out infinite;
        }
        
        /* Custom animation for hashtags */
        @keyframes hashtag-pulse {
            0% { opacity: 0.85; }
            50% { opacity: 1; }
            100% { opacity: 0.85; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Thanh điều hướng - sẽ được load từ sidebar-menu.html -->
        <div class="sidebar-container"></div>

        <!-- Phần nội dung chính -->
        <main class="main-content">
            <!-- Profile Header -->
            <div class="profile-header">
                <div class="profile-cover">
                    <img src="https://marketplace.canva.com/EAF3xGNlNSc/2/0/1600w/canva-xanh-l%C3%A1-v%C3%A0ng-phong-c%E1%BA%A3nh-c%C3%A2u-l%E1%BA%A1c-b%E1%BB%99-du-l%E1%BB%8Bch-%E1%BA%A3nh-b%C3%ACa-nh%C3%B3m-facebook-DqKwLtooIqU.jpg" alt="Cover Photo">
                    <button class="edit-cover-btn">
                        <i class="fas fa-camera"></i>
                        <span>Thay đổi ảnh bìa</span>
                    </button>
                </div>
                <div class="profile-info">
                    <div class="profile-avatar">
                        <img src="https://i.pravatar.cc/150?img=1" alt="Profile Avatar">
                        <button class="edit-avatar-btn">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                    <div class="profile-details">
                        <div class="profile-name">
                            <h1>Nguyễn Văn A</h1>
                            <span class="verified-badge">
                                <i class="fas fa-check-circle"></i>
                            </span>
                        </div>
                        <p class="profile-bio">Nhà thiết kế UI/UX | Content Creator | Tech Enthusiast</p>
                        <div class="profile-stats">
                            <div class="stat-item">
                                <span class="stat-number">1.2K</span>
                                <span class="stat-label">Bài viết</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number">5.6K</span>
                                <span class="stat-label">Người theo dõi</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number">3.8K</span>
                                <span class="stat-label">Đang theo dõi</span>
                            </div>
                        </div>
                        <div class="profile-actions">
                            <button class="primary-btn">
                                <i class="fas fa-edit"></i>
                                <span>Chỉnh sửa hồ sơ</span>
                            </button>
                            <button class="secondary-btn">
                                <i class="fas fa-share"></i>
                                <span>Chia sẻ</span>
                            </button>
                            <button class="secondary-btn">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Navigation -->
            <div class="profile-nav">
                <nav>
                    <a href="#" class="active">
                        <i class="fas fa-th-large"></i>
                        <span>Bài viết</span>
                    </a>
                    <a href="#">
                        <i class="fas fa-image"></i>
                        <span>Ảnh</span>
                    </a>
                    <a href="#">
                        <i class="fas fa-video"></i>
                        <span>Video</span>
                    </a>
                    <a href="#">
                        <i class="fas fa-users"></i>
                        <span>Bạn bè</span>
                    </a>
                    <a href="#">
                        <i class="fas fa-bookmark"></i>
                        <span>Đã lưu</span>
                    </a>
                </nav>
            </div>

            <!-- Profile Content -->
            <div class="profile-content">
                <!-- Posts Container -->
                <div class="posts-container">
                    <!-- Loading Indicator -->
                    <div class="posts-loading">
                        <div class="loading-spinner"></div>
                        <p>Đang tải bài viết...</p>
                    </div>
                    
                    <!-- Error Message Container -->
                    <div class="posts-error" style="display: none;">
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle fa-3x"></i>
                            <h3>Không thể tải bài viết</h3>
                            <p>Đã xảy ra lỗi khi tải bài viết. Vui lòng thử lại sau.</p>
                            <button class="retry-btn">Thử lại</button>
                        </div>
                    </div>
                    
                    <!-- Empty State -->
                    <div class="posts-empty" style="display: none;">
                        <div class="empty-state">
                            <i class="fas fa-newspaper fa-3x"></i>
                            <h3>Chưa có bài viết nào</h3>
                            <p>Hãy tạo bài viết đầu tiên của bạn để chia sẻ với mọi người.</p>
                            <button class="create-post-btn">Tạo bài viết</button>
                        </div>
                    </div>
                    
                    <!-- Posts Grid -->
                    <div class="posts-grid">
                        <!-- Posts will be loaded here dynamically -->
                    </div>
                </div>
            </div>
        </main>

        <!-- Phần bên phải - sẽ được load từ right-sidebar.html -->
        <div class="right-sidebar-container"></div>
    </div>

    <!-- Post loading overlay -->
    <div class="post-loading-overlay">
        <div class="post-loading-container">
            <div class="post-loading-spinner"></div>
            <div class="post-loading-progress">
                <div class="post-loading-progress-bar"></div>
            </div>
            <p class="post-loading-text">Đang xử lý...</p>
        </div>
    </div>

    <!-- Javascript -->
    <script src="../Scripts/api-service.js"></script>
    <script src="../Scripts/auth-guard.js"></script>
    <script src="../Scripts/sidebar-loader.js"></script>
    <script src="../Scripts/right-sidebar-loader.js"></script>
    <script src="../Scripts/page-transition.js"></script>
    <script src="../Scripts/profile-handler.js"></script>
    <script src="../Scripts/hashtag-formatter.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Element references
            const postsGrid = document.querySelector('.posts-grid');
            const postsLoading = document.querySelector('.posts-loading');
            const postsError = document.querySelector('.posts-error');
            const postsEmpty = document.querySelector('.posts-empty');
            const retryBtn = document.querySelector('.retry-btn');
            const createPostBtn = document.querySelector('.create-post-btn');
            const postLoadingOverlay = document.querySelector('.post-loading-overlay');
            const postLoadingProgressBar = document.querySelector('.post-loading-progress-bar');
            
            // Fetch user posts when page loads
            loadUserPosts();
            
            // Retry button event listener
            if (retryBtn) {
                retryBtn.addEventListener('click', function() {
                    loadUserPosts();
                });
            }
            
            // Create post button event listener
            if (createPostBtn) {
                createPostBtn.addEventListener('click', function() {
                    window.location.href = 'home.html';
                });
            }
            
            // Hiệu ứng cho các nút trong profile
            const actionButtons = document.querySelectorAll('.primary-btn, .secondary-btn');
            actionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    this.classList.add('animate__animated', 'animate__pulse');
                    setTimeout(() => {
                        this.classList.remove('animate__animated', 'animate__pulse');
                    }, 1000);
                });
            });

            // Hiệu ứng cho navigation
            const navLinks = document.querySelectorAll('.profile-nav a');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Hiệu ứng khi load trang
            const animatedElements = document.querySelectorAll('.animate__animated');
            setTimeout(() => {
                animatedElements.forEach((element, index) => {
                    setTimeout(() => {
                        element.style.opacity = '1';
                        element.style.transform = 'translateY(0)';
                    }, index * 200);
                });
            }, 300);
            
            // Function to load user posts
            function loadUserPosts() {
                // Show loading state
                postsLoading.style.display = 'flex';
                postsError.style.display = 'none';
                postsEmpty.style.display = 'none';
                postsGrid.innerHTML = '';
                
                // Get user ID from URL if specified
                const urlParams = new URLSearchParams(window.location.search);
                const userId = urlParams.get('userId');
                
                // If viewing someone else's profile (with userId in URL)
                if (userId) {
                    apiService.posts.getUserPosts(userId)
                        .then(response => {
                            // Hide loading state
                            postsLoading.style.display = 'none';
                            
                            if (response.data && response.data.posts && response.data.posts.length > 0) {
                                // Display posts
                                response.data.posts.forEach(post => {
                                    const postElement = createPostElement(post);
                                    postsGrid.appendChild(postElement);
                                });
                            } else {
                                // Show empty state
                                postsEmpty.style.display = 'block';
                            }
                        })
                        .catch(error => {
                            // Show error state
                            postsLoading.style.display = 'none';
                            postsError.style.display = 'block';
                            
                            // Hiển thị thông báo lỗi cụ thể trong giao diện
                            const errorMessage = document.querySelector('.posts-error p');
                            if (errorMessage) {
                                errorMessage.textContent = error.message || 'Đã xảy ra lỗi khi tải bài viết. Vui lòng thử lại sau.';
                            }
                            
                            console.error('Failed to load user posts:', error);
                            
                            // Hiển thị nút tải lại rõ ràng hơn
                            const retryBtn = document.querySelector('.retry-btn');
                            if (retryBtn) {
                                retryBtn.style.display = 'block';
                                retryBtn.textContent = 'Thử lại';
                            }
                        });
                } else {
                    // If viewing our own profile, use the optimized getMyPosts method
                    apiService.posts.getMyPosts()
                        .then(response => {
                            // Hide loading state
                            postsLoading.style.display = 'none';
                            
                            console.log('My posts response:', response);
                            
                            if (response.data && response.data.posts && response.data.posts.length > 0) {
                                // Display my posts directly
                                response.data.posts.forEach(post => {
                                    const postElement = createPostElement(post);
                                    postsGrid.appendChild(postElement);
                                });
                            } else {
                                // Show empty state
                                postsEmpty.style.display = 'block';
                            }
                        })
                        .catch(error => {
                            // Show error state
                            postsLoading.style.display = 'none';
                            postsError.style.display = 'block';
                            
                            // Hiển thị thông báo lỗi cụ thể trong giao diện
                            const errorMessage = document.querySelector('.posts-error p');
                            if (errorMessage) {
                                errorMessage.textContent = error.message || 'Đã xảy ra lỗi khi tải bài viết. Vui lòng thử lại sau.';
                            }
                            
                            console.error('Failed to load my posts:', error);
                            
                            // Hiển thị nút tải lại rõ ràng hơn
                            const retryBtn = document.querySelector('.retry-btn');
                            if (retryBtn) {
                                retryBtn.style.display = 'block';
                                retryBtn.textContent = 'Thử lại';
                            }
                        });
                }
            }
            
            // Function to create post element
            function createPostElement(post) {
                const postElement = document.createElement('div');
                postElement.className = 'post-item animate__animated animate__fadeIn';
                postElement.dataset.postId = post.post_id;
                
                // Create media HTML
                let mediaHTML = '';
                if (post.media && post.media.length > 0) {
                    const mediaCount = post.media.length;
                    
                    if (mediaCount === 1) {
                        // Single media file
                        const media = post.media[0];
                        if (media.type === 'image') {
                            mediaHTML = `<div class="post-media"><img src="${media.url}" alt=""></div>`;
                        } else if (media.type === 'video') {
                            mediaHTML = `<div class="post-media">
                                <video src="${media.url}" poster="${media.thumbnail}"></video>
                                <div class="video-play-button"><i class="fas fa-play"></i></div>
                            </div>`;
                        }
                    } else {
                        // Multiple media files
                        mediaHTML = `<div class="post-media grid-media count-${Math.min(mediaCount, 4)}">`;
                        
                        // Limit to display max 4 files
                        const displayCount = Math.min(mediaCount, 4);
                        for (let i = 0; i < displayCount; i++) {
                            const media = post.media[i];
                            if (media.type === 'image') {
                                // If this is the last displayed image and there are more
                                if (i === displayCount - 1 && mediaCount > displayCount) {
                                    mediaHTML += `
                                        <div class="media-item">
                                            <img src="${media.url}" alt="">
                                            <div class="more-media-overlay">+${mediaCount - displayCount + 1}</div>
                                        </div>
                                    `;
                                } else {
                                    mediaHTML += `<img src="${media.url}" alt="">`;
                                }
                            } else if (media.type === 'video') {
                                // If this is the last displayed video and there are more
                                if (i === displayCount - 1 && mediaCount > displayCount) {
                                    mediaHTML += `
                                        <div class="video-container">
                                            <video src="${media.url}" poster="${media.thumbnail}"></video>
                                            <div class="video-play-button"><i class="fas fa-play"></i></div>
                                            <div class="more-media-overlay">+${mediaCount - displayCount + 1}</div>
                                        </div>
                                    `;
                                } else {
                                    mediaHTML += `
                                        <div class="video-container">
                                            <video src="${media.url}" poster="${media.thumbnail}"></video>
                                            <div class="video-play-button"><i class="fas fa-play"></i></div>
                                        </div>
                                    `;
                                }
                            }
                        }
                        mediaHTML += '</div>';
                    }
                }
                
                // Format for emotion display
                let emotionHTML = '';
                if (post.emotion) {
                    emotionHTML = `<span class="post-emotion">- đang cảm thấy ${post.emotion.emoji} ${post.emotion.name}</span>`;
                }
                
                // Format for location display
                let locationHTML = '';
                if (post.location) {
                    locationHTML = `<span class="post-location">tại <i class="fas fa-map-marker-alt"></i> ${post.location}</span>`;
                }
                
                // Format date
                const postDate = new Date(post.created_at);
                const formattedDate = postDate.toLocaleString('vi-VN');
                
                // Format post content with hashtag highlighting
                const formattedContent = window.hashtagFormatter ? 
                    window.hashtagFormatter.formatTextWithHashtags(post.content || '') : 
                    (post.content || '');
                
                // Create post HTML structure
                postElement.innerHTML = `
                    <div class="post-header">
                        <div class="post-author">
                            <img src="${post.author.avatar}" alt="Author">
                            <div class="author-info">
                                <h4>${post.author.name}</h4>
                                <span class="post-time">${formattedDate} ${post.privacy !== 'public' ? `<i class="fas fa-${post.privacy === 'private' ? 'lock' : 'user-friends'}"></i>` : ''}</span>
                            </div>
                        </div>
                        <button class="post-menu">
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                    </div>
                    <div class="post-content">
                        <p>${formattedContent} ${emotionHTML} ${locationHTML}</p>
                        ${mediaHTML}
                    </div>
                    <div class="post-actions">
                        <button class="action-btn ${post.is_liked ? 'liked' : ''}">
                            <i class="${post.is_liked ? 'fas' : 'far'} fa-heart"></i>
                            <span>${post.likes_count}</span>
                        </button>
                        <button class="action-btn">
                            <i class="far fa-comment"></i>
                            <span>${post.comments_count}</span>
                        </button>
                        <button class="action-btn">
                            <i class="far fa-share"></i>
                            <span>${post.shares_count}</span>
                        </button>
                    </div>
                `;
                
                // Set up like button functionality
                const likeButton = postElement.querySelector('.action-btn:nth-child(1)');
                setupLikeButton(likeButton, post.post_id);
                
                // Set up video play functionality
                const playButtons = postElement.querySelectorAll('.video-play-button');
                playButtons.forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const videoContainer = this.closest('.video-container') || this.closest('.post-media');
                        const video = videoContainer.querySelector('video');
                        if (video) {
                            if (video.paused) {
                                video.play();
                                this.style.display = 'none';
                            } else {
                                video.pause();
                                this.style.display = 'flex';
                            }
                        }
                    });
                });
                
                // Set up video event listeners
                const videos = postElement.querySelectorAll('video');
                videos.forEach(video => {
                    video.addEventListener('play', function() {
                        const playButton = this.parentElement.querySelector('.video-play-button');
                        if (playButton) playButton.style.display = 'none';
                    });
                    
                    video.addEventListener('pause', function() {
                        const playButton = this.parentElement.querySelector('.video-play-button');
                        if (playButton) playButton.style.display = 'flex';
                    });
                    
                    video.addEventListener('ended', function() {
                        const playButton = this.parentElement.querySelector('.video-play-button');
                        if (playButton) playButton.style.display = 'flex';
                    });
                });
                
                return postElement;
            }
            
            // Function to handle like/unlike post
            function setupLikeButton(button, postId) {
                if (!button) return;
                
                button.addEventListener('click', function() {
                    this.classList.toggle('liked');
                    const icon = this.querySelector('i');
                    const countElement = this.querySelector('span');
                    let count = parseInt(countElement.textContent);
                    
                    if (this.classList.contains('liked')) {
                        icon.classList.remove('far');
                        icon.classList.add('fas');
                        countElement.textContent = count + 1;
                        
                        // Animation effect
                        icon.classList.add('animate__animated', 'animate__heartBeat');
                        setTimeout(() => {
                            icon.classList.remove('animate__animated', 'animate__heartBeat');
                        }, 1000);
                    } else {
                        icon.classList.remove('fas');
                        icon.classList.add('far');
                        countElement.textContent = Math.max(0, count - 1);
                    }
                    
                    // Call API to toggle like
                    if (apiService && apiService.posts) {
                        apiService.posts.toggleLike(postId).catch(error => {
                            console.error('Error toggling like:', error);
                            // Revert UI if API call fails
                            this.classList.toggle('liked');
                            if (this.classList.contains('liked')) {
                                icon.classList.remove('far');
                                icon.classList.add('fas');
                                countElement.textContent = count + 1;
                            } else {
                                icon.classList.remove('fas');
                                icon.classList.add('far');
                                countElement.textContent = Math.max(0, count - 1);
                            }
                        });
                    }
                });
            }
            
            // Function to show loading overlay
            function showLoadingOverlay() {
                if (postLoadingOverlay) {
                    postLoadingOverlay.classList.add('active');
                    updateProgressBar(0);
                }
            }
            
            // Function to hide loading overlay
            function hideLoadingOverlay() {
                if (postLoadingOverlay) {
                    postLoadingOverlay.classList.remove('active');
                }
            }
            
            // Function to update progress bar
            function updateProgressBar(percent) {
                if (postLoadingProgressBar) {
                    postLoadingProgressBar.style.width = percent + '%';
                }
            }
        });
    </script>
</body>
</html> 