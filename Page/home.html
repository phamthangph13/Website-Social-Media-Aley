<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aley - Trang chủ</title>
    <link rel="stylesheet" href="Styles/global.css">
    <link rel="stylesheet" href="Styles/home.css">
    <link rel="stylesheet" href="Styles/post-creator.css">
    <link rel="stylesheet" href="Styles/widget_post_edit.css">
    <link rel="stylesheet" href="Styles/post_options.css">
    <link rel="stylesheet" href="Styles/loading_states.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        /* Hashtag styles */
        .hashtag {
            font-weight: 600;
            border-radius: 4px;
            padding: 0 2px;
            margin: 0 -2px;
            display: inline-block;
            position: relative;
            animation: hashtag-pulse 2s ease-in-out infinite;
        }
        
        /* Custom animation for hashtags */
        @keyframes hashtag-pulse {
            0% { opacity: 0.85; }
            50% { opacity: 1; }
            100% { opacity: 0.85; }
        }
        
        /* Special styling for hashtag links */
        a.hashtag {
            text-decoration: none;
            cursor: pointer;
        }
        
        a.hashtag:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Thanh điều hướng - sẽ được load từ sidebar-menu.html -->
        <div class="sidebar-container"></div>

        <!-- Phần nội dung chính -->
        <main class="main-content">
            <!-- Phần đăng bài -->
            <div class="create-post-card card">
                <div class="card-header">
                    <h2>Tạo bài viết</h2>
                </div>
                <div class="card-body">
                    <div class="user-input">
                        <div class="avatar">
                            <img src="../assets/images/default-avatar.png" alt="Avatar" data-default="true" onerror="this.src='https://i.pravatar.cc/150?img=12';">
                        </div>
                        <div class="post-input">
                            <textarea placeholder="Bạn đang nghĩ gì?"></textarea>
                        </div>
                    </div>
                    <div class="post-attachments">
                        <button class="attachment-btn">
                            <i class="fas fa-image"></i>
                            <span>Ảnh/Video</span>
                        </button>
                        <button class="attachment-btn">
                            <i class="fas fa-smile"></i>
                            <span>Cảm xúc</span>
                        </button>
                        <button class="attachment-btn">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>Check in</span>
                        </button>
                    </div>
                    <div class="post-actions">
                        <div class="privacy-selector">
                            <button type="button" class="privacy-btn">
                                <i class="fas fa-globe"></i>
                                <span class="privacy-text">Công khai</span>
                                <i class="fas fa-caret-down"></i>
                            </button>
                            <div class="privacy-dropdown">
                                <div class="privacy-option" data-privacy="public">
                                    <i class="fas fa-globe"></i>
                                    <div class="privacy-details">
                                        <span class="privacy-name">Công khai</span>
                                        <span class="privacy-desc">Tất cả mọi người có thể xem</span>
                                    </div>
                                </div>
                                <div class="privacy-option" data-privacy="friends">
                                    <i class="fas fa-user-friends"></i>
                                    <div class="privacy-details">
                                        <span class="privacy-name">Bạn bè</span>
                                        <span class="privacy-desc">Chỉ bạn bè có thể xem</span>
                                    </div>
                                </div>
                                <div class="privacy-option" data-privacy="private">
                                    <i class="fas fa-lock"></i>
                                    <div class="privacy-details">
                                        <span class="privacy-name">Chỉ mình tôi</span>
                                        <span class="privacy-desc">Chỉ bạn có thể xem</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="post-btn">
                            <i class="fas fa-paper-plane"></i>
                            <span>Đăng</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Bảng tin -->
            <div class="feed">
                <!-- Khu vực hiển thị trạng thái loading -->
                <div class="feed-loading">
                    <div class="loading-spinner"></div>
                    <p>Đang tải bài viết...</p>
                </div>
                
                <!-- Các bài viết sẽ được thêm vào từ API -->
            </div>
        </main>

        <!-- Phần bên phải - sẽ được load từ right-sidebar.html -->
        <div class="right-sidebar-container"></div>
    </div>

    <!-- Post loading overlay -->
    <div class="post-loading-overlay">
        <div class="post-loading-container">
            <div class="post-loading-spinner"></div>
            <div class="post-loading-progress">
                <div class="post-loading-progress-bar"></div>
            </div>
            <p class="post-loading-text">Đang đăng bài viết...</p>
        </div>
    </div>

    <!-- Modal để chỉnh sửa bài viết -->
    <div class="edit-post-modal">
        <div class="edit-post-container">
            <div class="edit-post-header">
                <h3>Chỉnh sửa bài viết</h3>
                <button class="close-edit-modal"><i class="fas fa-times"></i></button>
            </div>
            <div class="edit-post-body">
                <div class="user-input edit-user-input">
                    <div class="avatar">
                        <img src="../assets/images/default-avatar.png" alt="Avatar" onerror="this.src='https://i.pravatar.cc/150?img=12';">
                    </div>
                    <div class="post-input">
                        <textarea id="edit-post-content" placeholder="Bạn đang nghĩ gì?"></textarea>
                    </div>
                </div>
                <div class="post-attachments">
                    <button class="attachment-btn">
                        <i class="fas fa-image"></i>
                        <span>Ảnh/Video</span>
                    </button>
                    <button class="attachment-btn">
                        <i class="fas fa-smile"></i>
                        <span>Cảm xúc</span>
                    </button>
                    <button class="attachment-btn">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Check in</span>
                    </button>
                </div>
            </div>
            <div class="edit-post-footer">
                <div class="privacy-selector">
                    <button type="button" class="privacy-btn">
                        <i class="fas fa-globe"></i>
                        <span class="privacy-text">Công khai</span>
                        <i class="fas fa-caret-down"></i>
                    </button>
                    <div class="privacy-dropdown">
                        <div class="privacy-option" data-privacy="public">
                            <i class="fas fa-globe"></i>
                            <div class="privacy-details">
                                <span class="privacy-name">Công khai</span>
                                <span class="privacy-desc">Tất cả mọi người có thể xem</span>
                            </div>
                        </div>
                        <div class="privacy-option" data-privacy="friends">
                            <i class="fas fa-user-friends"></i>
                            <div class="privacy-details">
                                <span class="privacy-name">Bạn bè</span>
                                <span class="privacy-desc">Chỉ bạn bè có thể xem</span>
                            </div>
                        </div>
                        <div class="privacy-option" data-privacy="private">
                            <i class="fas fa-lock"></i>
                            <div class="privacy-details">
                                <span class="privacy-name">Chỉ mình tôi</span>
                                <span class="privacy-desc">Chỉ bạn có thể xem</span>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="save-edit-btn">
                    <i class="fas fa-save"></i>
                    <span>Lưu thay đổi</span>
                </button>
            </div>
        </div>
    </div>
    <div class="modal-overlay"></div>

    <!-- Javascript -->
    <script src="../Scripts/api-service.js"></script>
    <script src="../Scripts/auth-guard.js"></script>
    <script src="../Scripts/sidebar-loader.js"></script>
    <script src="../Scripts/right-sidebar-loader.js"></script>
    <script src="../Scripts/page-transition.js"></script>
    <script src="../Scripts/hashtag-formatter.js"></script>
    <script src="../Scripts/post-creator.js"></script>
    <script src="../Scripts/post-edit.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Hiển thị loading state
            const feedElement = document.querySelector('.feed');
            const loadingElement = document.querySelector('.feed-loading');
            const postLoadingOverlay = document.querySelector('.post-loading-overlay');
            const postLoadingProgressBar = document.querySelector('.post-loading-progress-bar');
            const createPostAvatar = document.querySelector('.create-post-card .avatar img');
            
            // Tải dữ liệu người dùng và hiển thị avatar
            fetchUserAvatar();
            
            // Tải bài viết từ API
            loadPosts();
            
            // Hàm lấy avatar của người dùng hiện tại
            async function fetchUserAvatar() {
                // Kiểm tra xem người dùng đã đăng nhập chưa
                if (localStorage.getItem('aley_token')) {
                    try {
                        // Lấy thông tin người dùng hiện tại từ API
                        const userData = await AleyAPI.User.getCurrentUser();
                        
                        // Cập nhật avatar trong phần đăng bài viết
                        if (createPostAvatar && userData.avatar) {
                            // Cập nhật avatar và xóa thuộc tính data-default
                            createPostAvatar.src = userData.avatar;
                            createPostAvatar.removeAttribute('data-default');
                            
                            // Lưu avatar vào localStorage để sử dụng nhanh trong các lần sau
                            try {
                                localStorage.setItem('aley_user_avatar', userData.avatar);
                                localStorage.setItem('aley_user_name', userData.fullName || 'Người dùng Aley');
                                
                                // Lưu thêm email và user ID để sử dụng cho việc xác định chủ sở hữu bài viết
                                if (userData.email) {
                                    localStorage.setItem('aley_user_email', userData.email);
                                }
                                if (userData.user_id || userData.id) {
                                    localStorage.setItem('aley_user_id', userData.user_id || userData.id);
                                }
                            } catch (e) {
                                console.warn('Không thể lưu thông tin người dùng vào localStorage:', e);
                            }
                        }
                    } catch (error) {
                        console.error('Không thể lấy thông tin người dùng:', error);
                        
                        // Nếu không lấy được từ API, thử lấy từ localStorage
                        const savedAvatar = localStorage.getItem('aley_user_avatar');
                        if (savedAvatar && createPostAvatar) {
                            createPostAvatar.src = savedAvatar;
                            createPostAvatar.removeAttribute('data-default');
                        }
                    }
                }
            }
            
            // Thiết lập sự kiện cho nút đăng bài
            const postBtn = document.querySelector('.post-btn');
            if (postBtn) {
                postBtn.addEventListener('click', function() {
                    // Lấy nội dung bài viết
                    const postContent = document.querySelector('.post-input textarea').value;
                    if (!postContent.trim()) {
                        alert('Vui lòng nhập nội dung bài viết!');
                        return;
                    }
                    
                    // Hiển thị loading overlay
                    showPostLoading();
                    
                    // Chuẩn bị dữ liệu bài viết
                    const postData = {
                        content: postContent,
                        privacy: 'public' // Mặc định là công khai
                    };
                    
                    // Giả lập tiến trình tải lên (thay bằng API thực tế)
                    let progress = 0;
                    const progressInterval = setInterval(() => {
                        progress += 5;
                        if (progress <= 100) {
                            updateProgressBar(progress);
                        } else {
                            clearInterval(progressInterval);
                            
                            // Sau khi hoàn thành, ẩn loading và làm mới bài viết
                            setTimeout(() => {
                                hidePostLoading();
                                
                                // Thêm bài viết mới vào đầu feed nếu thành công
                                AleyAPI.User.getCurrentUser()
                                    .then(userData => {
                                        // Lấy ID của user từ API trả về hoặc localStorage
                                        const userId = userData.user_id || userData.id || localStorage.getItem('aley_user_id');
                                        const userEmail = userData.email || localStorage.getItem('aley_user_email');
                                        
                                        // Tạo đối tượng bài viết giả lập (thường sẽ được trả về từ API)
                                        const mockPost = {
                                            post_id: 'temp_' + Date.now(),
                                            content: postContent,
                                            created_at: new Date().toISOString(),
                                            author: {
                                                id: userId, // Đảm bảo có ID người dùng
                                                user_id: userId, // Thêm user_id để xác định chủ sở hữu
                                                _id: userId, // Thêm _id cho tương thích với MongoDB
                                                name: userData.fullName || localStorage.getItem('aley_user_name') || 'Người dùng Aley',
                                                avatar: userData.avatar || localStorage.getItem('aley_user_avatar') || 'https://i.pravatar.cc/150?img=12',
                                                email: userEmail // Thêm email để so khớp
                                            },
                                            media: [],
                                            likes_count: 0,
                                            comments_count: 0,
                                            shares_count: 0,
                                            privacy: 'public',
                                            is_liked: false,
                                            is_own_post: true // Đánh dấu đây là bài viết của người dùng hiện tại
                                        };
                                        
                                        console.log('Created new post with author:', mockPost.author);
                                        
                                        // Tạo phần tử bài viết và thêm vào đầu feed
                                        const postElement = createPostElement(mockPost);
                                        feedElement.insertBefore(postElement, feedElement.firstChild);
                                        
                                        // Xóa nội dung trong textarea sau khi đăng
                                        document.querySelector('.post-input textarea').value = '';
                                    })
                                    .catch(error => {
                                        console.error('Không thể lấy thông tin người dùng:', error);
                                        // Xóa nội dung trong textarea sau khi đăng
                                        document.querySelector('.post-input textarea').value = '';
                                    });
                            }, 500);
                        }
                    }, 200);
                    
                    // Trong thực tế, bạn sẽ gọi API và xử lý phản hồi tại đây
                    // apiService.posts.createPost(postData, updateProgressBar)
                    //     .then(response => {
                    //         hidePostLoading();
                    //         document.querySelector('.post-input textarea').value = '';
                    //         // Thêm bài viết mới vào đầu feed
                    //         const postElement = createPostElement(response.data);
                    //         feedElement.insertBefore(postElement, feedElement.firstChild);
                    //     })
                    //     .catch(error => {
                    //         hidePostLoading();
                    //         alert('Đăng bài viết thất bại: ' + error.message);
                    //     });
                });
            }
            
            // Hàm hiển thị loading khi đăng bài
            function showPostLoading() {
                postLoadingOverlay.classList.add('active');
                updateProgressBar(0);
            }
            
            // Hàm ẩn loading khi đăng bài
            function hidePostLoading() {
                postLoadingOverlay.classList.remove('active');
            }
            
            // Hàm cập nhật thanh tiến trình
            function updateProgressBar(percent) {
                postLoadingProgressBar.style.width = percent + '%';
            }
            
            // Hàm tải bài viết từ API
            function loadPosts() {
                // Hiển thị loading
                if (loadingElement) {
                    loadingElement.style.display = 'flex';
                }
                
                // Kiểm tra xem user đã đăng nhập chưa
                const authToken = localStorage.getItem('aley_token');
                
                // Hiển thị avatar của người dùng nếu đã đăng nhập
                if (authToken) {
                    // Kiểm tra xem avatar có phải là mặc định không
                    if (createPostAvatar.hasAttribute('data-default') || createPostAvatar.src.includes('pravatar')) {
                        // Trước tiên thử lấy từ localStorage nếu có
                        const savedAvatar = localStorage.getItem('aley_user_avatar');
                        if (savedAvatar) {
                            createPostAvatar.src = savedAvatar;
                            createPostAvatar.removeAttribute('data-default');
                        } else {
                            // Lấy thông tin user để cập nhật avatar
                            AleyAPI.User.getCurrentUser()
                                .then(userData => {
                                    if (userData.avatar) {
                                        createPostAvatar.src = userData.avatar;
                                        createPostAvatar.removeAttribute('data-default');
                                        
                                        // Lưu vào localStorage
                                        try {
                                            localStorage.setItem('aley_user_avatar', userData.avatar);
                                            localStorage.setItem('aley_user_name', userData.fullName || 'Người dùng Aley');
                                        } catch (e) {
                                            console.warn('Không thể lưu avatar vào localStorage:', e);
                                        }
                                    }
                                })
                                .catch(error => {
                                    console.error('Không thể lấy thông tin người dùng:', error);
                                });
                        }
                    }
                } else {
                    // Ẩn phần tạo bài viết nếu chưa đăng nhập
                    const createPostCard = document.querySelector('.create-post-card');
                    if (createPostCard) {
                        createPostCard.style.display = 'none';
                    }
                }
                
                // Xác định function để gọi API (getFeed nếu đã đăng nhập, getPosts nếu chưa)
                const apiFunction = authToken ? 
                    apiService.posts.getFeed() : 
                    apiService.posts.getPosts();
                
                // Gọi API và xử lý kết quả
                apiFunction
                    .then(response => {
                        // Ẩn loading
                        if (loadingElement) {
                            loadingElement.style.display = 'none';
                        }
                        
                        // Xóa nội dung hiện tại trong feed
                        feedElement.innerHTML = '';
                        feedElement.appendChild(loadingElement);
                        
                        if (response.data && response.data.posts && response.data.posts.length > 0) {
                            // Thêm các bài viết từ API vào feed
                            response.data.posts.forEach(post => {
                                const postElement = createPostElement(post);
                                feedElement.appendChild(postElement);
                            });
                        } else {
                            // Hiển thị thông báo không có bài viết
                            const noPostsElement = document.createElement('div');
                            noPostsElement.className = 'no-posts-message';
                            noPostsElement.innerHTML = `
                                <div class="empty-state">
                                    <i class="fas fa-newspaper fa-3x"></i>
                                    <h3>Chưa có bài viết nào</h3>
                                    <p>Hãy theo dõi thêm bạn bè hoặc đăng bài viết đầu tiên của bạn.</p>
                                </div>
                            `;
                            feedElement.appendChild(noPostsElement);
                        }
                    })
                    .catch(error => {
                        // Ẩn loading
                        if (loadingElement) {
                            loadingElement.style.display = 'none';
                        }
                        
                        // Hiển thị thông báo lỗi
                        console.error('Không thể tải bài viết:', error);
                        const errorElement = document.createElement('div');
                        errorElement.className = 'error-message';
                        errorElement.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-exclamation-triangle fa-3x"></i>
                                <h3>Không thể tải bài viết</h3>
                                <p>Đã xảy ra lỗi khi tải bài viết. Vui lòng thử lại sau.</p>
                                <button class="retry-btn">Thử lại</button>
                            </div>
                        `;
                        feedElement.appendChild(errorElement);
                        
                        // Thêm event listener cho nút thử lại
                        const retryButton = errorElement.querySelector('.retry-btn');
                        if (retryButton) {
                            retryButton.addEventListener('click', function() {
                                loadPosts();
                            });
                        }
                    });
            }
            
            // Hàm tạo phần tử bài viết từ dữ liệu
            function createPostElement(post) {
                const postElement = document.createElement('div');
                postElement.className = 'post-card card animate__animated animate__fadeIn';
                postElement.dataset.postId = post.post_id;
                
                // Tạo HTML cho phần media
                let mediaHTML = '';
                if (post.media && post.media.length > 0) {
                    const mediaCount = post.media.length;
                    
                    if (mediaCount === 1) {
                        // Nếu chỉ có 1 media file
                        const media = post.media[0];
                        if (media.type === 'image') {
                            mediaHTML = `<div class="post-media"><img src="${media.url}" alt=""></div>`;
                        } else if (media.type === 'video') {
                            mediaHTML = `<div class="post-media"><video src="${media.url}" controls poster="${media.thumbnail}"></video></div>`;
                        }
                    } else {
                        // Nếu có nhiều media files
                        mediaHTML = `<div class="post-media grid-media count-${Math.min(mediaCount, 6)}">`;
                        
                        // Giới hạn hiển thị tối đa 6 files
                        const displayCount = Math.min(mediaCount, 6);
                        for (let i = 0; i < displayCount; i++) {
                            const media = post.media[i];
                            if (media.type === 'image') {
                                // Nếu là ảnh cuối và còn nhiều ảnh khác chưa hiển thị
                                if (i === displayCount - 1 && mediaCount > displayCount) {
                                    mediaHTML += `
                                        <div class="media-item">
                                            <img src="${media.url}" alt="">
                                            <div class="more-media-overlay">+${mediaCount - displayCount + 1}</div>
                                        </div>
                                    `;
                                } else {
                                    mediaHTML += `<img src="${media.url}" alt="">`;
                                }
                            } else if (media.type === 'video') {
                                // Nếu là video cuối và còn nhiều files khác chưa hiển thị
                                if (i === displayCount - 1 && mediaCount > displayCount) {
                                    mediaHTML += `
                                        <div class="video-container">
                                            <video src="${media.url}" poster="${media.thumbnail}"></video>
                                            <div class="video-play-button"><i class="fas fa-play"></i></div>
                                            <div class="more-media-overlay">+${mediaCount - displayCount + 1}</div>
                                        </div>
                                    `;
                                } else {
                                    mediaHTML += `
                                        <div class="video-container">
                                            <video src="${media.url}" poster="${media.thumbnail}"></video>
                                            <div class="video-play-button"><i class="fas fa-play"></i></div>
                                        </div>
                                    `;
                                }
                            }
                        }
                        mediaHTML += '</div>';
                    }
                }
                
                // Tạo HTML cho phần cảm xúc
                let emotionHTML = '';
                if (post.emotion) {
                    emotionHTML = `<span class="post-emotion">- đang cảm thấy ${post.emotion.emoji} ${post.emotion.name}</span>`;
                }
                
                // Tạo HTML cho phần vị trí
                let locationHTML = '';
                if (post.location) {
                    locationHTML = `<span class="post-location">tại <i class="fas fa-map-marker-alt"></i> ${post.location}</span>`;
                }
                
                // Định dạng thời gian
                const postDate = new Date(post.created_at);
                const formattedDate = postDate.toLocaleString('vi-VN');
                
                // Format post content with hashtag highlighting
                const formattedContent = window.hashtagFormatter ? 
                    window.hashtagFormatter.formatTextWithHashtags(post.content || '') : 
                    (post.content || '');
                
                // Tạo HTML cho bài viết
                postElement.innerHTML = `
                    <div class="card-header post-header">
                        <div class="post-author">
                            <div class="avatar">
                                <img src="${post.author.avatar}" alt="Avatar">
                            </div>
                            <div class="author-info">
                                <h4>${post.author.name}</h4>
                                <p>${formattedDate} ${post.privacy !== 'public' ? `<i class="fas fa-${post.privacy === 'private' ? 'lock' : 'user-friends'}"></i>` : ''}</p>
                            </div>
                        </div>
                        <div class="post-options">
                            <i class="fas fa-ellipsis-h"></i>
                            <div class="post-options-dropdown">
                                <!-- Options will be dynamically populated -->
                            </div>
                        </div>
                    </div>
                    <div class="card-body post-content">
                        <p>${formattedContent} ${emotionHTML} ${locationHTML}</p>
                        ${mediaHTML}
                    </div>
                    <div class="card-footer post-footer">
                        <div class="post-stats">
                            <div class="likes">
                                <i class="fas fa-heart"></i>
                                <span>${post.likes_count}</span>
                            </div>
                            <div class="comments">
                                <i class="fas fa-comment"></i>
                                <span>${post.comments_count}</span>
                            </div>
                            <div class="shares">
                                <i class="fas fa-share"></i>
                                <span>${post.shares_count}</span>
                            </div>
                        </div>
                        <div class="post-actions">
                            <button class="action-btn ${post.is_liked ? 'liked' : ''}">
                                <i class="${post.is_liked ? 'fas' : 'far'} fa-heart"></i>
                                <span>Thích</span>
                            </button>
                            <button class="action-btn">
                                <i class="far fa-comment"></i>
                                <span>Bình luận</span>
                            </button>
                            <button class="action-btn">
                                <i class="far fa-share-square"></i>
                                <span>Chia sẻ</span>
                            </button>
                        </div>
                    </div>
                `;
                
                // Thiết lập sự kiện cho nút thích
                const likeButton = postElement.querySelector('.action-btn:nth-child(1)');
                setupLikeButton(likeButton, post.post_id);
                
                // Thiết lập sự kiện cho post options
                setupPostOptions(postElement, post);
                
                // Thiết lập sự kiện cho nút play video
                const playButtons = postElement.querySelectorAll('.video-play-button');
                playButtons.forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const videoContainer = this.closest('.video-container');
                        const video = videoContainer.querySelector('video');
                        if (video) {
                            if (video.paused) {
                                video.play();
                                this.style.display = 'none';
                            } else {
                                video.pause();
                                this.style.display = 'flex';
                            }
                        }
                    });
                });
                
                // Thiết lập sự kiện cho overlay "xem thêm"
                const moreOverlays = postElement.querySelectorAll('.more-media-overlay');
                moreOverlays.forEach(overlay => {
                    overlay.addEventListener('click', function() {
                        // Mở modal xem đầy đủ media (có thể thực hiện sau)
                        alert('Mở chế độ xem đầy đủ hình ảnh và video');
                    });
                });
                
                // Thiết lập sự kiện cho videos
                const videos = postElement.querySelectorAll('video');
                videos.forEach(video => {
                    video.addEventListener('play', function() {
                        const playButton = this.parentElement.querySelector('.video-play-button');
                        if (playButton) {
                            playButton.style.display = 'none';
                        }
                    });
                    
                    video.addEventListener('pause', function() {
                        const playButton = this.parentElement.querySelector('.video-play-button');
                        if (playButton) {
                            playButton.style.display = 'flex';
                        }
                    });
                    
                    video.addEventListener('ended', function() {
                        const playButton = this.parentElement.querySelector('.video-play-button');
                        if (playButton) {
                            playButton.style.display = 'flex';
                        }
                    });
                });
                
                return postElement;
            }
            
            // Hàm thiết lập nút thích
            function setupLikeButton(likeButton, postId) {
                likeButton.addEventListener('click', function() {
                    this.classList.toggle('liked');
                    const icon = this.querySelector('i');
                    const likeCountElement = this.closest('.post-footer').querySelector('.likes span');
                    let likeCount = parseInt(likeCountElement.textContent);
                    
                    if (this.classList.contains('liked')) {
                        icon.classList.remove('far');
                        icon.classList.add('fas');
                        likeCountElement.textContent = likeCount + 1;
                        
                        // Hiệu ứng heart bouncing
                        icon.classList.add('animate__animated', 'animate__heartBeat');
                        setTimeout(() => {
                            icon.classList.remove('animate__animated', 'animate__heartBeat');
                        }, 1000);
                        
                        // Gọi API thích bài viết nếu có apiService
                        if (typeof apiService !== 'undefined' && apiService.posts) {
                            apiService.posts.toggleLike(postId)
                                .catch(error => {
                                    console.error('Error liking post:', error);
                                    this.classList.remove('liked');
                                    icon.classList.remove('fas');
                                    icon.classList.add('far');
                                    likeCountElement.textContent = likeCount;
                                });
                        }
                    } else {
                        icon.classList.remove('fas');
                        icon.classList.add('far');
                        likeCountElement.textContent = Math.max(0, likeCount - 1);
                        
                        // Gọi API bỏ thích bài viết nếu có apiService
                        if (typeof apiService !== 'undefined' && apiService.posts) {
                            apiService.posts.toggleLike(postId)
                                .catch(error => {
                                    console.error('Error unliking post:', error);
                                    this.classList.add('liked');
                                    icon.classList.remove('far');
                                    icon.classList.add('fas');
                                    likeCountElement.textContent = likeCount;
                                });
                        }
                    }
                });
            }
            
            // Hàm thiết lập post options
            function setupPostOptions(postElement, post) {
                const optionsButton = postElement.querySelector('.post-options i');
                const optionsDropdown = postElement.querySelector('.post-options-dropdown');
                
                if (!optionsButton || !optionsDropdown) return;
                
                // Kiểm tra xem người dùng có đăng nhập không
                const isLoggedIn = !!localStorage.getItem('aley_token');
                if (!isLoggedIn) return;
                
                // Lấy thông tin người dùng hiện tại từ localStorage trước (nhanh hơn)
                const storedUserId = localStorage.getItem('aley_user_id');
                const storedUserEmail = localStorage.getItem('aley_user_email');
                const storedUserName = localStorage.getItem('aley_user_name');
                
                // Lấy thông tin người dùng hiện tại từ API (nếu cần)
                const getCurrentUserId = async () => {
                    // Nếu đã có ID trong localStorage, ưu tiên sử dụng
                    if (storedUserId) {
                        console.log('Using stored user ID:', storedUserId);
                        return storedUserId;
                    }
                    
                    try {
                        const userData = await AleyAPI.User.getCurrentUser();
                        console.log('API returned user data:', userData);
                        
                        // Lưu thông tin người dùng vào localStorage để sử dụng sau này
                        if (userData.user_id || userData.id) {
                            const userId = userData.user_id || userData.id;
                            localStorage.setItem('aley_user_id', userId);
                            if (userData.email) localStorage.setItem('aley_user_email', userData.email);
                            if (userData.fullName) localStorage.setItem('aley_user_name', userData.fullName);
                            return userId;
                        }
                        return null;
                    } catch (error) {
                        console.error('Không thể lấy thông tin người dùng từ API:', error);
                        return null;
                    }
                };
                
                // Thiết lập sự kiện click cho nút options
                optionsButton.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    
                    // Đóng tất cả các dropdown khác trước khi mở dropdown này
                    document.querySelectorAll('.post-options-dropdown.active').forEach(dropdown => {
                        if (dropdown !== optionsDropdown) {
                            dropdown.classList.remove('active');
                        }
                    });
                    
                    // Toggle dropdown
                    optionsDropdown.classList.toggle('active');
                    
                    // Nếu dropdown được mở, cập nhật nội dung dựa trên chủ sở hữu bài viết
                    if (optionsDropdown.classList.contains('active')) {
                        optionsDropdown.innerHTML = '<div class="loading-options"><div class="loading-spinner"></div></div>';
                        
                        const currentUserId = await getCurrentUserId();
                        console.log('Current user ID:', currentUserId);
                        console.log('Post author details:', post.author);
                        
                        // Chi tiết debug thông tin tác giả bài viết
                        console.log('Post author ID:', post.author && post.author.id);
                        console.log('Post author user_id:', post.author && post.author.user_id);
                        console.log('Post author _id:', post.author && post.author._id);
                        console.log('Post author email:', post.author && post.author.email);
                        console.log('Post author name:', post.author && post.author.name);
                        console.log('Stored user email:', storedUserEmail);
                        console.log('Stored user name:', storedUserName);
                        
                        // Check if post_id is related to a temp post (posts created by the user during the current session)
                        const isTemporaryPost = post.post_id && post.post_id.includes('temp_');
                        console.log('Is temporary post:', isTemporaryPost);
                        
                        // Check if the post was created by the current user's mock post function
                        const isCreatedByCurrentUser = post.author && post.author.name === storedUserName;
                        console.log('Is created by current user (name match):', isCreatedByCurrentUser);
                        
                        // Kiểm tra xem bài viết có phải của người dùng hiện tại không - 5 cách khác nhau
                        const isOwnPostById = currentUserId && post.author && post.author.id === currentUserId;
                        const isOwnPostByUserId = currentUserId && post.author && post.author.user_id === currentUserId;
                        const isOwnPostBy_Id = currentUserId && post.author && post.author._id === currentUserId;
                        const isOwnPostByEmail = storedUserEmail && post.author && post.author.email === storedUserEmail;
                        const isOwnPostByName = storedUserName && post.author && post.author.name === storedUserName;
                        
                        console.log('Is own post (by id):', isOwnPostById);
                        console.log('Is own post (by user_id):', isOwnPostByUserId);
                        console.log('Is own post (by _id):', isOwnPostBy_Id);
                        console.log('Is own post (by email):', isOwnPostByEmail);
                        console.log('Is own post (by name):', isOwnPostByName);
                        
                        // Nếu không thể xác định chính xác, dùng mock data cho demo
                        // Luôn hiển thị một số post là của người dùng hiện tại
                        const mockIsOwnPost = post.post_id && (
                            post.post_id.includes('temp_') || // Mock post vừa tạo
                            post.post_id.endsWith('1') || // Giả sử post có ID kết thúc bằng 1 là của mình
                            post.post_id.endsWith('4') // Thêm một số post khác
                        );
                        
                        console.log('Is own post (by mock rules):', mockIsOwnPost);
                        
                        // Check if post has explicit is_own_post flag (most reliable)
                        const hasOwnPostFlag = post.is_own_post === true;
                        console.log('Post has own_post flag:', hasOwnPostFlag);
                        
                        // Kết hợp tất cả các cách để xác định
                        const finalIsOwnPost = hasOwnPostFlag || isOwnPostById || isOwnPostByUserId || isOwnPostBy_Id || 
                                              isOwnPostByEmail || isOwnPostByName || isTemporaryPost || 
                                              isCreatedByCurrentUser || mockIsOwnPost;
                        
                        console.log('Final determination - Is own post:', finalIsOwnPost);
                        
                        // ALWAYS make our temporary posts show as our own
                        if (isTemporaryPost) {
                            console.log('Forcing own post options for temporary post');
                        }
                        
                        // Tạo danh sách options tương ứng
                        let optionsHTML = '';
                        
                        if (finalIsOwnPost) {
                            // Options cho bài viết của chính chủ
                            optionsHTML = `
                                <div class="option-item edit-post">
                                    <i class="fas fa-edit"></i>
                                    <span>Chỉnh sửa bài viết</span>
                                </div>
                                <div class="option-item delete-post">
                                    <i class="fas fa-trash-alt"></i>
                                    <span>Xoá bài viết</span>
                                </div>
                                <div class="option-item privacy-settings">
                                    <i class="fas fa-lock"></i>
                                    <span>Cài đặt quyền riêng tư</span>
                                </div>
                            `;
                        } else {
                            // Options cho bài viết của người khác
                            optionsHTML = `
                                <div class="option-item report-post">
                                    <i class="fas fa-flag"></i>
                                    <span>Báo cáo bài viết này</span>
                                </div>
                                <div class="option-item hide-post">
                                    <i class="fas fa-eye-slash"></i>
                                    <span>Ẩn bài viết này</span>
                                </div>
                                <div class="option-item save-post">
                                    <i class="fas fa-bookmark"></i>
                                    <span>Lưu bài viết này</span>
                                </div>
                            `;
                        }
                        
                        optionsDropdown.innerHTML = optionsHTML;
                        
                        // Thiết lập sự kiện cho các options
                        if (finalIsOwnPost) {
                            // Sự kiện chỉnh sửa bài viết
                            const editBtn = optionsDropdown.querySelector('.edit-post');
                            if (editBtn) {
                                editBtn.addEventListener('click', function() {
                                    // Xử lý chỉnh sửa bài viết
                                    showEditPostModal(post);
                                    optionsDropdown.classList.remove('active');
                                });
                            }
                            
                            // Sự kiện xoá bài viết
                            const deleteBtn = optionsDropdown.querySelector('.delete-post');
                            if (deleteBtn) {
                                deleteBtn.addEventListener('click', function() {
                                    if (confirm('Bạn có chắc chắn muốn xoá bài viết này không?')) {
                                        // Xử lý xoá bài viết
                                        alert('Tính năng xoá bài viết đang được phát triển');
                                        optionsDropdown.classList.remove('active');
                                    }
                                });
                            }
                            
                            // Sự kiện cài đặt quyền riêng tư
                            const privacyBtn = optionsDropdown.querySelector('.privacy-settings');
                            if (privacyBtn) {
                                privacyBtn.addEventListener('click', function() {
                                    // Xử lý cài đặt quyền riêng tư
                                    alert('Tính năng cài đặt quyền riêng tư đang được phát triển');
                                    optionsDropdown.classList.remove('active');
                                });
                            }
                        } else {
                            // Sự kiện báo cáo bài viết
                            const reportBtn = optionsDropdown.querySelector('.report-post');
                            if (reportBtn) {
                                reportBtn.addEventListener('click', function() {
                                    // Xử lý báo cáo bài viết
                                    alert('Tính năng báo cáo bài viết đang được phát triển');
                                    optionsDropdown.classList.remove('active');
                                });
                            }
                            
                            // Sự kiện ẩn bài viết
                            const hideBtn = optionsDropdown.querySelector('.hide-post');
                            if (hideBtn) {
                                hideBtn.addEventListener('click', function() {
                                    // Xử lý ẩn bài viết
                                    alert('Tính năng ẩn bài viết đang được phát triển');
                                    optionsDropdown.classList.remove('active');
                                    
                                    // Thêm hiệu ứng ẩn bài viết
                                    postElement.classList.add('post-hidden');
                                    setTimeout(() => {
                                        postElement.style.display = 'none';
                                    }, 300);
                                });
                            }
                            
                            // Sự kiện lưu bài viết
                            const saveBtn = optionsDropdown.querySelector('.save-post');
                            if (saveBtn) {
                                saveBtn.addEventListener('click', function() {
                                    // Xử lý lưu bài viết
                                    alert('Tính năng lưu bài viết đang được phát triển');
                                    optionsDropdown.classList.remove('active');
                                    
                                    // Thông báo đã lưu
                                    const notification = document.createElement('div');
                                    notification.className = 'save-notification';
                                    notification.textContent = 'Đã lưu bài viết';
                                    document.body.appendChild(notification);
                                    
                                    setTimeout(() => {
                                        notification.classList.add('show');
                                        setTimeout(() => {
                                            notification.classList.remove('show');
                                            setTimeout(() => {
                                                notification.remove();
                                            }, 300);
                                        }, 2000);
                                    }, 10);
                                });
                            }
                        }
                    }
                });
                
                // Đóng dropdown khi click ra ngoài
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.post-options') && optionsDropdown.classList.contains('active')) {
                        optionsDropdown.classList.remove('active');
                    }
                });
            }
            
            // Variable declarations and initialization for the home page functionality
            // The rest of the post edit functionality has been moved to post-edit.js
        });
    </script>
    <style>
        /* Styles for feed loading states have been moved to loading_states.css */
        /* Post options styles have been moved to post_options.css */
    </style>
</body>
</html> 