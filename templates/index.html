<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aley - Mạng xã hội kết nối mọi người</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Try different ways to load CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="login-page">
        <!-- Left Content Section -->
        <div class="content-section">
            <div class="floating-shape shape1"></div>
            <div class="floating-shape shape2"></div>
            <div class="floating-shape shape3"></div>
            
            <div class="content-wrapper">
                <div class="site-logo">
                    <i class="fas fa-people-group logo-icon"></i>
                    <div class="logo-text">Aley</div>
                </div>
                
                <h1 class="tagline">Kết nối, Chia sẻ và Khám phá.</h1>
                <p class="description">
                    Tham gia cộng đồng Aley để kết nối với bạn bè, gia đình và thế giới xung quanh bạn. 
                    Chia sẻ khoảnh khắc, theo dõi các sở thích và khám phá những người có chung đam mê.
                </p>
                
                <div class="feature-list">
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fas fa-user-friends"></i>
                        </div>
                        <div class="feature-text">Kết nối với bạn bè và mở rộng mạng lưới của bạn</div>
                    </div>
                    
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fas fa-photo-video"></i>
                        </div>
                        <div class="feature-text">Chia sẻ ảnh, video và những khoảnh khắc đáng nhớ</div>
                    </div>
                    
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fas fa-globe"></i>
                        </div>
                        <div class="feature-text">Khám phá nội dung và cộng đồng phù hợp với bạn</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Form Section -->
        <div class="form-section">
            <div class="login-container">
                <!-- Form đăng nhập -->
                <div id="login-form-container" class="form-container active">
                    <div class="login-header">
                        <h1>Chào mừng trở lại!</h1>
                        <p>Vui lòng đăng nhập để tiếp tục hành trình của bạn</p>
                    </div>
                    
                    <form id="login-form">
                        <div class="form-group">
                            <label for="email">Email hoặc tên đăng nhập</label>
                            <div class="input-with-icon">
                                <i class="fas fa-user"></i>
                                <input type="text" id="email" name="email" placeholder="Nhập email hoặc tên đăng nhập" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="password">Mật khẩu</label>
                            <div class="input-with-icon">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="password" name="password" placeholder="Nhập mật khẩu" required>
                            </div>
                        </div>

                        <div class="forgot-password">
                            <a href="#" id="forgot-password-link">Quên mật khẩu?</a>
                        </div>

                        <div class="checkbox-container">
                            <input type="checkbox" id="remember" name="remember">
                            <label for="remember">Ghi nhớ đăng nhập</label>
                        </div>

                        <button type="submit" class="login-btn">Đăng nhập</button>
                    </form>

                    <div class="social-login">
                        <p>Hoặc đăng nhập với</p>
                        <div class="social-icons">
                            <div class="social-icon facebook">
                                <i class="fab fa-facebook-f"></i>
                            </div>
                            <div class="social-icon google">
                                <i class="fab fa-google"></i>
                            </div>
                            <div class="social-icon twitter">
                                <i class="fab fa-twitter"></i>
                            </div>
                        </div>
                    </div>

                    <div class="register-link">
                        <p>Chưa có tài khoản? <a href="#" id="register-link">Đăng ký ngay</a></p>
                    </div>
                </div>

                <!-- Form đăng ký -->
                <div id="register-form-container" class="form-container">
                    <div class="login-header">
                        <h1>Tạo tài khoản mới</h1>
                        <p>Tham gia cộng đồng Aley ngay hôm nay</p>
                    </div>
                    
                    <form id="register-form">
                        <div class="form-group">
                            <label for="fullname">Họ và tên</label>
                            <div class="input-with-icon">
                                <i class="fas fa-user"></i>
                                <input type="text" id="fullname" name="fullname" placeholder="Nhập họ và tên" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="register-email">Email</label>
                            <div class="input-with-icon">
                                <i class="fas fa-envelope"></i>
                                <input type="email" id="register-email" name="email" placeholder="Nhập email" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="register-password">Mật khẩu</label>
                            <div class="input-with-icon">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="register-password" name="password" placeholder="Nhập mật khẩu" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="confirm-password">Xác nhận mật khẩu</label>
                            <div class="input-with-icon">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="confirm-password" name="confirm-password" placeholder="Nhập lại mật khẩu" required>
                            </div>
                        </div>

                        <button type="submit" class="login-btn">Đăng ký</button>
                    </form>

                    <div class="register-link">
                        <p>Đã có tài khoản? <a href="#" id="login-link">Đăng nhập</a></p>
                    </div>
                </div>

                <!-- Form quên mật khẩu -->
                <div id="forgot-password-container" class="form-container">
                    <div class="login-header">
                        <h1>Khôi phục mật khẩu</h1>
                        <p>Nhập email của bạn để nhận liên kết đặt lại mật khẩu</p>
                    </div>
                    
                    <form id="forgot-password-form">
                        <div class="form-group">
                            <label for="recovery-email">Email</label>
                            <div class="input-with-icon">
                                <i class="fas fa-envelope"></i>
                                <input type="email" id="recovery-email" name="email" placeholder="Nhập email đã đăng ký" required>
                            </div>
                        </div>

                        <button type="submit" class="login-btn">Gửi liên kết khôi phục</button>
                    </form>

                    <div class="register-link">
                        <p>Nhớ mật khẩu? <a href="#" id="back-to-login">Quay lại đăng nhập</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Funções de API para autenticação
        const API_URL = 'https://website-social-media-aley.onrender.com/api/auth';

        // Função para fazer login
        async function loginUser(email, password) {
            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                // Primeiro verificamos se a resposta está vazia
                const text = await response.text();
                
                // Se a resposta estiver vazia, tratamos como erro
                if (!text) {
                    throw new Error('Resposta vazia do servidor');
                }
                
                // Depois tentamos analisar como JSON
                const data = JSON.parse(text);
                
                if (!response.ok) {
                    // Verificar se é um erro de email não verificado
                    if (response.status === 403 && data.message && data.message.includes('Email not verified')) {
                        // Mostrar opção para reenviar email de verificação
                        alert('Email não verificado! Enviamos um link de verificação para seu email quando você se registrou.');
                        const resend = confirm('Deseja que enviemos um novo link de verificação?');
                        
                        if (resend) {
                            await resendVerificationEmail(email);
                        }
                        return false;
                    }
                    throw new Error(data.message || 'Erro ao fazer login');
                }
                
                // Salvar token no localStorage
                localStorage.setItem('token', data.token);
                localStorage.setItem('userData', JSON.stringify(data.user));
                
                return true;
            } catch (error) {
                console.error('Erro de login:', error);
                alert(error.message || 'Erro ao processar o login. Tente novamente mais tarde.');
                return false;
            }
        }

        // Função para registrar usuário
        async function registerUser(fullname, email, password, confirmPassword) {
            try {
                const response = await fetch(`${API_URL}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        fullname, 
                        email, 
                        password, 
                        confirm_password: confirmPassword 
                    })
                });
                
                // Primeiro verificamos se a resposta está vazia
                const text = await response.text();
                
                // Se a resposta estiver vazia, tratamos como erro
                if (!text) {
                    throw new Error('Resposta vazia do servidor');
                }
                
                // Depois tentamos analisar como JSON
                const data = JSON.parse(text);
                
                if (!response.ok) {
                    throw new Error(data.message || 'Erro ao registrar');
                }
                
                alert('Registro concluído com sucesso! Verifique seu email para ativar sua conta.');
                return true;
            } catch (error) {
                console.error('Erro de registro:', error);
                alert(error.message || 'Erro ao processar o registro. Tente novamente mais tarde.');
                return false;
            }
        }

        // Função para solicitar redefinição de senha
        async function forgotPassword(email) {
            try {
                const response = await fetch(`${API_URL}/forgot-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email })
                });
                
                // Primeiro verificamos se a resposta está vazia
                const text = await response.text();
                
                // Se a resposta estiver vazia, tratamos como erro
                if (!text) {
                    throw new Error('Resposta vazia do servidor');
                }
                
                // Depois tentamos analisar como JSON
                const data = JSON.parse(text);
                
                if (!response.ok) {
                    throw new Error(data.message || 'Erro ao processar solicitação');
                }
                
                alert('Se o email existir em nossa base de dados, enviaremos um link para redefinição de senha.');
                return true;
            } catch (error) {
                console.error('Erro na recuperação de senha:', error);
                alert(error.message || 'Erro ao processar a solicitação. Tente novamente mais tarde.');
                return false;
            }
        }

        // Função para reenviar email de verificação
        async function resendVerificationEmail(email) {
            try {
                const response = await fetch(`${API_URL}/resend-verification`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email })
                });
                
                // Primeiro verificamos se a resposta está vazia
                const text = await response.text();
                
                // Se a resposta estiver vazia, tratamos como erro
                if (!text) {
                    throw new Error('Resposta vazia do servidor');
                }
                
                // Depois tentamos analisar como JSON
                const data = JSON.parse(text);
                
                if (!response.ok) {
                    throw new Error(data.message || 'Erro ao reenviar email');
                }
                
                alert('Se o email existir e não estiver verificado, um novo link de verificação foi enviado.');
                return true;
            } catch (error) {
                console.error('Erro ao reenviar verificação:', error);
                alert(error.message || 'Erro ao reenviar o email de verificação. Tente novamente mais tarde.');
                return false;
            }
        }

        // Thêm hiệu ứng khi submit form
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const button = document.querySelector('.login-btn');
            const originalText = button.textContent;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            button.textContent = 'Đang đăng nhập...';
            button.disabled = true;
            
            const success = await loginUser(email, password);
            
            if (success) {
                button.textContent = 'Đăng nhập thành công!';
                button.style.background = 'linear-gradient(45deg, #10b981, #059669)';
                
                // Chuyển hướng sau khi đăng nhập
                setTimeout(() => {
                    window.location.href = '/home.html';
                }, 1500);
            } else {
                button.textContent = originalText;
                button.disabled = false;
                button.style.background = 'linear-gradient(45deg, var(--primary), var(--primary-hover))';
            }
        });

        // Hiệu ứng cho các input
        const inputs = document.querySelectorAll('input');
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                this.parentElement.style.transform = 'scale(1.02)';
                this.parentElement.style.transition = 'transform 0.3s';
            });
            
            input.addEventListener('blur', function() {
                this.parentElement.style.transform = 'scale(1)';
            });
        });

        // Hiệu ứng cho social icons
        const socialIcons = document.querySelectorAll('.social-icon');
        socialIcons.forEach(icon => {
            icon.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px) rotate(5deg)';
            });
            
            icon.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0) rotate(0)';
            });
        });

        // Xử lý chuyển đổi giữa các form
        document.addEventListener('DOMContentLoaded', function() {
            const loginFormContainer = document.getElementById('login-form-container');
            const registerFormContainer = document.getElementById('register-form-container');
            const forgotPasswordContainer = document.getElementById('forgot-password-container');
            
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            const registerLink = document.getElementById('register-link');
            const loginLink = document.getElementById('login-link');
            const backToLoginLink = document.getElementById('back-to-login');
            
            // Hàm ẩn tất cả các form
            function hideAllForms() {
                loginFormContainer.classList.remove('active');
                registerFormContainer.classList.remove('active');
                forgotPasswordContainer.classList.remove('active');
            }
            
            // Đăng ký ngay
            registerLink.addEventListener('click', function(e) {
                e.preventDefault();
                hideAllForms();
                registerFormContainer.classList.add('active');
            });
            
            // Quên mật khẩu
            forgotPasswordLink.addEventListener('click', function(e) {
                e.preventDefault();
                hideAllForms();
                forgotPasswordContainer.classList.add('active');
            });
            
            // Quay lại đăng nhập
            loginLink.addEventListener('click', function(e) {
                e.preventDefault();
                hideAllForms();
                loginFormContainer.classList.add('active');
            });
            
            // Quay lại đăng nhập từ quên mật khẩu
            backToLoginLink.addEventListener('click', function(e) {
                e.preventDefault();
                hideAllForms();
                loginFormContainer.classList.add('active');
            });
            
            // Xử lý form quên mật khẩu
            document.getElementById('forgot-password-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const email = document.getElementById('recovery-email').value;
                const button = this.querySelector('button');
                const originalText = button.textContent;
                
                button.textContent = 'Processando...';
                button.disabled = true;
                
                const success = await forgotPassword(email);
                
                if (success) {
                    setTimeout(() => {
                        hideAllForms();
                        loginFormContainer.classList.add('active');
                        button.textContent = originalText;
                        button.disabled = false;
                    }, 1500);
                } else {
                    button.textContent = originalText;
                    button.disabled = false;
                }
            });
            
            // Xử lý form đăng ký
            document.getElementById('register-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const fullname = document.getElementById('fullname').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                const button = this.querySelector('button');
                const originalText = button.textContent;
                
                button.textContent = 'Processando...';
                button.disabled = true;
                
                const success = await registerUser(fullname, email, password, confirmPassword);
                
                if (success) {
                    setTimeout(() => {
                        hideAllForms();
                        loginFormContainer.classList.add('active');
                        button.textContent = originalText;
                        button.disabled = false;
                    }, 1500);
                } else {
                    button.textContent = originalText;
                    button.disabled = false;
                }
            });

            // Verificar se o usuário já está logado
            const token = localStorage.getItem('token');
            
            if (token) {
                try {
                    // Verificar se o token é válido fazendo uma chamada ao endpoint /api/auth/profile
                    fetch('/api/auth/profile', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            // Se o status não for 200, o token é inválido
                            throw new Error('Token inválido');
                        }
                        return response.text();
                    })
                    .then(text => {
                        if (!text.trim()) {
                            throw new Error('Resposta vazia');
                        }
                        
                        try {
                            // Tentar analisar o JSON
                            JSON.parse(text);
                            // Se chegou aqui, o token é válido
                            window.location.href = '/home.html';
                        } catch (e) {
                            console.error('Resposta não é um JSON válido:', e);
                            throw new Error('Resposta inválida');
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao validar token:', error);
                        // Remove token inválido e mostra o login
                        localStorage.removeItem('token');
                        localStorage.removeItem('userData');
                        loginFormContainer.classList.add('active');
                    });
                } catch (error) {
                    console.error('Erro ao verificar token:', error);
                    localStorage.removeItem('token');
                    localStorage.removeItem('userData');
                    loginFormContainer.classList.add('active');
                }
            } else {
                // Se não houver token, mostrar o formulário de login
                loginFormContainer.classList.add('active');
            }
        });
    </script>
</body>
</html> 